<!-- Generated by SpecStory -->

# æä¾› image width å’Œ height çš„è®¨è®º (2025-06-06 15:49:49)

_**User**_

è¿™é‡Œå¦‚æœæä¾›äº† image width å’Œ height æ˜¯ä¸æ˜¯ä¸éœ€è¦ä½¿ç”¨ new Image() äº†

---

_**Assistant**_



---

ä½ æå‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„ä¼˜åŒ–ç‚¹ï¼ç¡®å®ï¼Œå¦‚æœæä¾›äº†å›¾ç‰‡çš„ width å’Œ heightï¼Œå¯ä»¥ä¼˜åŒ–åŠ è½½æµç¨‹ï¼Œä½†ä¸èƒ½å®Œå…¨è·³è¿‡ `new Image()`ï¼Œå› ä¸ºåç»­åˆ›å»ºçº¹ç†æ—¶ä»éœ€è¦å®é™…çš„å›¾ç‰‡æ•°æ®ã€‚

ä¸è¿‡å¯ä»¥è¿™æ ·ä¼˜åŒ–ï¼š

---

```diff
    }
  
-   async loadImage(url: string) {
+   async loadImage(url: string, preknownWidth?: number, preknownHeight?: number) {
      this.originalImageSrc = url
      this.isLoadingTexture = true // å¼€å§‹åŠ è½½å›¾ç‰‡
      this.notifyLoadingStateChange(true, 'å›¾ç‰‡åŠ è½½ä¸­...')
+     
+     // å¦‚æœæä¾›äº†é¢„çŸ¥çš„å°ºå¯¸ï¼Œå¯ä»¥ç«‹å³è®¾ç½®å¹¶å¼€å§‹å‡†å¤‡æ¸²æŸ“ç®¡é“
+     if (preknownWidth && preknownHeight) {
+       this.imageWidth = preknownWidth
+       this.imageHeight = preknownHeight
+       
+       // ç«‹å³è®¾ç½®ç¼©æ”¾å’Œæ¸²æŸ“ç­–ç•¥
+       this.setupInitialScaling()
+       this.determineRenderingStrategy()
+       
+       console.info(`Using preknown dimensions: ${preknownWidth}Ã—${preknownHeight}`)
+       console.info('Starting parallel image loading for texture creation...')
+     }
+     
      const image = new Image()
      image.crossOrigin = 'anonymous'
```

```diff
        image.onload = async () => {
          try {
-           this.imageWidth = image.width
-           this.imageHeight = image.height
- 
-           // ä¼°ç®—å†…å­˜éœ€æ±‚å¹¶å†³å®šæ¸²æŸ“ç­–ç•¥
-           const imagePixels = image.width * image.height
-           const baseMemoryMB = (imagePixels * 4) / (1024 * 1024) // RGBA åŸºç¡€å†…å­˜
-           const estimatedMaxMemoryMB = baseMemoryMB * 3 // ä¼°ç®—æœ€å¤šéœ€è¦çš„å†…å­˜ï¼ˆå¤šä¸ªLODçº§åˆ«ï¼‰
- 
-           console.info(`Image loaded: ${image.width}Ã—${image.height}`)
-           console.info(`Base memory requirement: ${baseMemoryMB.toFixed(1)} MB`)
-           console.info(
-             `Estimated max memory: ${estimatedMaxMemoryMB.toFixed(1)} MB`,
-           )
-           console.info(
-             `Memory budget: ${(this.maxMemoryBudget / 1024 / 1024).toFixed(1)} MB`,
-           )
- 
-           // å†³å®šæ˜¯å¦ä½¿ç”¨ç“¦ç‰‡æ¸²æŸ“
-           const maxDimension = Math.max(image.width, image.height)
-           const shouldUseTiling =
-             estimatedMaxMemoryMB > this.maxMemoryBudget / (1024 * 1024) ||
-             imagePixels > 50 * 1024 * 1024 || // 50M åƒç´ 
-             maxDimension > 8192 // ä»»ä¸€è¾¹è¶…è¿‡ 8K
- 
-           if (shouldUseTiling) {
-             this.useTiledRendering = true
-             console.info(`ğŸ§© Using tiled rendering for large image`)
-             console.info(`Tile size: ${this.tileSize}Ã—${this.tileSize}`)
-             console.info(`Max tiles in memory: ${this.maxTilesInMemory}`)
+           // å¦‚æœæ²¡æœ‰é¢„çŸ¥å°ºå¯¸ï¼Œç°åœ¨è·å–
+           if (!preknownWidth || !preknownHeight) {
+             this.imageWidth = image.width
+             this.imageHeight = image.height
+             
+             // è®¾ç½®ç¼©æ”¾å’Œæ¸²æŸ“ç­–ç•¥
+             this.setupInitialScaling()
+             this.determineRenderingStrategy()
            } else {
-             console.info(`ğŸ“„ Using standard LOD rendering`)
-           }
- 
-           // å…ˆè®¾ç½®æ­£ç¡®çš„ç¼©æ”¾å€¼ï¼Œå†åˆ›å»ºçº¹ç†
-           if (this.config.centerOnInit) {
-             this.fitImageToScreen()
-           } else {
-             // å³ä½¿ä¸å±…ä¸­ï¼Œä¹Ÿéœ€è¦å°†ç›¸å¯¹ç¼©æ”¾è½¬æ¢ä¸ºç»å¯¹ç¼©æ”¾
-             const fitToScreenScale = this.getFitToScreenScale()
-             this.scale = fitToScreenScale * this.config.initialScale
+             // éªŒè¯é¢„çŸ¥å°ºå¯¸æ˜¯å¦æ­£ç¡®
+             if (image.width !== preknownWidth || image.height !== preknownHeight) {
+               console.warn(`Preknown dimensions mismatch: expected ${preknownWidth}Ã—${preknownHeight}, actual ${image.width}Ã—${image.height}`)
+               this.imageWidth = image.width
+               this.imageHeight = image.height
+               
+               // é‡æ–°è®¾ç½®ç¼©æ”¾å’Œæ¸²æŸ“ç­–ç•¥
+               this.setupInitialScaling()
+               this.determineRenderingStrategy()
+             }
            }
  
```

```diff
      })
    }
+ 
+   private setupInitialScaling() {
+     // å…ˆè®¾ç½®æ­£ç¡®çš„ç¼©æ”¾å€¼
+     if (this.config.centerOnInit) {
+       this.fitImageToScreen()
+     } else {
+       // å³ä½¿ä¸å±…ä¸­ï¼Œä¹Ÿéœ€è¦å°†ç›¸å¯¹ç¼©æ”¾è½¬æ¢ä¸ºç»å¯¹ç¼©æ”¾
+       const fitToScreenScale = this.getFitToScreenScale()
+       this.scale = fitToScreenScale * this.config.initialScale
+     }
+   }
+ 
+   private determineRenderingStrategy() {
+     // ä¼°ç®—å†…å­˜éœ€æ±‚å¹¶å†³å®šæ¸²æŸ“ç­–ç•¥
+     const imagePixels = this.imageWidth * this.imageHeight
+     const baseMemoryMB = (imagePixels * 4) / (1024 * 1024) // RGBA åŸºç¡€å†…å­˜
+     const estimatedMaxMemoryMB = baseMemoryMB * 3 // ä¼°ç®—æœ€å¤šéœ€è¦çš„å†…å­˜ï¼ˆå¤šä¸ªLODçº§åˆ«ï¼‰
+ 
+     console.info(`Image loaded: ${this.imageWidth}Ã—${this.imageHeight}`)
+     console.info(`Base memory requirement: ${baseMemoryMB.toFixed(1)} MB`)
+     console.info(
+       `Estimated max memory: ${estimatedMaxMemoryMB.toFixed(1)} MB`,
+     )
+     console.info(
+       `Memory budget: ${(this.maxMemoryBudget / 1024 / 1024).toFixed(1)} MB`,
+     )
+ 
+     // å†³å®šæ˜¯å¦ä½¿ç”¨ç“¦ç‰‡æ¸²æŸ“
+     const maxDimension = Math.max(this.imageWidth, this.imageHeight)
+     const shouldUseTiling =
+       estimatedMaxMemoryMB > this.maxMemoryBudget / (1024 / 1024) ||
+       imagePixels > 50 * 1024 * 1024 || // 50M åƒç´ 
+       maxDimension > 8192 // ä»»ä¸€è¾¹è¶…è¿‡ 8K
+ 
+     if (shouldUseTiling) {
+       this.useTiledRendering = true
+       console.info(`ğŸ§© Using tiled rendering for large image`)
+       console.info(`Tile size: ${this.tileSize}Ã—${this.tileSize}`)
+       console.info(`Max tiles in memory: ${this.maxTilesInMemory}`)
+     } else {
+       console.info(`ğŸ“„ Using standard LOD rendering`)
+     }
+   }
  
    private async createTexture(image: HTMLImageElement) {
```

---

çœ‹èµ·æ¥æœ‰ä¸ªå°bugï¼Œæˆ‘ä¿®å¤ä¸€ä¸‹å†…å­˜é¢„ç®—çš„è®¡ç®—ï¼š

---



---

ç°åœ¨è¿˜éœ€è¦æ›´æ–°æ¥å£å®šä¹‰ä»¥æ”¯æŒå¯é€‰çš„widthå’Œheightå‚æ•°ï¼š

---

<details>
            <summary>Searched codebase "loadImage interface definition" â€¢ **25** results</summary>
        
| File | Lines |
|------|-------|
| `apps/web/src/lib/image-loader-manager.ts` | L23-28 |
| `apps/web/src/lib/image-loader-manager.ts` | L17-23 |
| `apps/web/src/lib/image-loader-manager.ts` | L33-39 |
| `packages/webgl-viewer/src/lodWorker.ts` | L1-10 |
| `packages/webgl-viewer/src/interface.ts` | L28-52 |
| `apps/web/src/core/types/photo.ts` | L9-15 |
| `scripts/photo-loader.ts` | L1-21 |
| `apps/web/src/types/photo.ts` | L1-23 |
| `apps/web/src/components/ui/photo-viewer/LoadingIndicator.tsx` | L1-18 |
| `apps/web/src/core/types/photo.ts` | L15-37 |
| `apps/web/src/lib/image-loader-manager.ts` | L1-17 |
| `apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L42-121 |
| `apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L1-42 |
| `apps/web/src/components/ui/photo-viewer/LoadingIndicator.tsx` | L18-23 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L422-475 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L395-422 |
| `apps/web/src/lib/image-loader-manager.ts` | L66-139 |
| `apps/web/src/core/photo/processor.ts` | L1-27 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L89-136 |
| `apps/web/src/components/ui/photo-viewer/LoadingIndicator.tsx` | L23-65 |
| `apps/web/src/core/types/photo.ts` | L42-48 |
| `packages/webgl-viewer/src/interface.ts` | L58-94 |
| `apps/web/src/lib/image-loader-manager.ts` | L28-33 |
| `apps/web/src/lib/image-utils.ts` | L54-79 |
| `apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L121-178 |

</details>

---

è®©æˆ‘æŸ¥çœ‹WebGLæŸ¥çœ‹å™¨çš„æ¥å£å®šä¹‰ï¼š

---

<details>
            <summary>Searched codebase "WebGLImageViewer loadImage" â€¢ **2** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |

</details>

---

Read file: packages/webgl-viewer/src/WebGLImageViewer.tsx

---

ç°åœ¨æˆ‘éœ€è¦ä¿®æ”¹WebGLImageViewerç»„ä»¶ä»¥æ”¯æŒä¼ é€’widthå’Œheightå‚æ•°ï¼š

---

Read file: packages/webgl-viewer/src/interface.ts

---

ç°åœ¨æˆ‘æ›´æ–°æ¥å£å®šä¹‰ä»¥åŒ…å«å¯é€‰çš„widthå’Œheightå‚æ•°ï¼š

---



---

ç°åœ¨æ›´æ–°WebGLImageViewerç»„ä»¶ä»¥ä¼ é€’è¿™äº›å‚æ•°ï¼š

---



---

æˆ‘éœ€è¦ä¿®å¤linteré”™è¯¯ï¼Œå°†widthå’Œheightæ·»åŠ åˆ°configä¸­ï¼š

---



---

ç°åœ¨æ›´æ–°WebGLImageViewerEngineä»¥ä½¿ç”¨configä¸­çš„widthå’Œheightï¼š

---



---

ç°åœ¨æˆ‘éœ€è¦æ›´æ–°ProgressiveImageç»„ä»¶ä»¥ä¼ é€’å›¾ç‰‡çš„widthå’Œheightï¼š

---



---

è®©æˆ‘å…ˆæ£€æŸ¥ProgressiveImageç»„ä»¶çš„å†…å®¹ï¼š

---

<details>
            <summary>Grep search for "WebGLImageViewer" â€¢ **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | Lundefined | `import type { WebGLImageViewerRef } from '@photo-gallery/webgl-viewer'` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L1 | `import { WebGLImageViewer } from '@photo-gallery/webgl-viewer'` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L68 | `const transformRef = useRef<WebGLImageViewerRef>(null)` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L197 | `<WebGLImageViewer` |

</details>

---

Read file: apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx

---

ç°åœ¨æˆ‘çœ‹åˆ°äº†WebGLImageViewerçš„ç”¨æ³•ï¼Œæˆ‘éœ€è¦æ·»åŠ widthå’Œheightå‚æ•°ï¼š

---



---

æˆ‘éœ€è¦åœ¨WebGLImageViewerç»„ä»¶ä¸­ä½¿ç”¨è¿™äº›å‚æ•°ï¼š

---



---

ç°åœ¨éœ€è¦æ›´æ–°è°ƒç”¨ProgressiveImageçš„åœ°æ–¹ï¼Œä¼ é€’å›¾ç‰‡çš„widthå’Œheightã€‚è®©æˆ‘æ£€æŸ¥ç”¨æ³•ï¼š

---

<details>
            <summary>Grep search for "ProgressiveImage" â€¢ **3** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L19 | `import { ProgressiveImage } from './ProgressiveImage'` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L319 | `<ProgressiveImage` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L18 | `interface ProgressiveImageProps {` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L43 | `export const ProgressiveImage = ({` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L64 | `}: ProgressiveImageProps) => {` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L18 | `interface ProgressiveImageProps {` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L43 | `export const ProgressiveImage = ({` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/ProgressiveImage.tsx` | L64 | `}: ProgressiveImageProps) => {` |

</details>

---

Read file: apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx

---

æˆ‘çœ‹åˆ°ä»£ç å·²ç»åœ¨ä½¿ç”¨widthå’Œheightäº†ï¼è®©æˆ‘æ£€æŸ¥imageSizeæ˜¯ä»å“ªé‡Œæ¥çš„ï¼š

---

<details>
            <summary>Grep search for "imageSize" â€¢ **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L177 | `const imageSize = getImageDisplaySize()` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L325 | `isCurrentImage ? imageSize.width : undefined` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L328 | `isCurrentImage ? imageSize.height : undefined` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L177 | `const imageSize = getImageDisplaySize()` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L325 | `isCurrentImage ? imageSize.width : undefined` |
| `file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx` | L328 | `isCurrentImage ? imageSize.height : undefined` |

</details>

---

Read file: apps/web/src/components/ui/photo-viewer/PhotoViewer.tsx

---

å®Œç¾ï¼æˆ‘çœ‹åˆ°ä»£ç å·²ç»åœ¨æ­£ç¡®åœ°ä¼ é€’å›¾ç‰‡çš„åŸå§‹å°ºå¯¸äº†ã€‚è®©æˆ‘æ£€æŸ¥æœ€åä¸€ä¸ªç»†èŠ‚ï¼Œçœ‹çœ‹currentPhoto.widthå’ŒcurrentPhoto.heightæ˜¯å¦æ¥è‡ªPhotoManifestï¼š

---



---

æˆ‘éœ€è¦åˆ é™¤æœªä½¿ç”¨çš„imageSizeå˜é‡ï¼š

---



---

æˆ‘éœ€è¦åˆ é™¤æˆ–é‡å‘½ågetImageDisplaySizeå‡½æ•°ï¼š

---



---

ç°åœ¨è®©æˆ‘æ€»ç»“ä¸€ä¸‹è¿™æ¬¡ä¼˜åŒ–çš„æ•ˆæœï¼š

## ä¼˜åŒ–æ€»ç»“

ä½ çš„å»ºè®®éå¸¸æ­£ç¡®ï¼æˆ‘å·²ç»å®ç°äº†è¿™ä¸ªä¼˜åŒ–ï¼Œç°åœ¨æ”¯æŒæä¾›é¢„çŸ¥çš„å›¾ç‰‡å°ºå¯¸æ¥ä¼˜åŒ–åŠ è½½æµç¨‹ï¼š

### ä¸»è¦å˜åŒ–ï¼š

1. **WebGLImageViewerEngine.loadImage()** æ–°å¢å¯é€‰å‚æ•°ï¼š
   ```typescript
   async loadImage(url: string, preknownWidth?: number, preknownHeight?: number)
   ```

2. **ä¼˜åŒ–åŠ è½½æµç¨‹**ï¼š
   - å¦‚æœæä¾›äº†é¢„çŸ¥å°ºå¯¸ï¼Œç«‹å³è®¾ç½®å›¾ç‰‡å°ºå¯¸å¹¶å¼€å§‹å‡†å¤‡æ¸²æŸ“ç®¡é“
   - å¹¶è¡ŒåŠ è½½å®é™…å›¾ç‰‡æ•°æ®ç”¨äºçº¹ç†åˆ›å»º
   - éªŒè¯é¢„çŸ¥å°ºå¯¸ä¸å®é™…å°ºå¯¸æ˜¯å¦åŒ¹é…

3. **ç•Œé¢æ”¯æŒ**ï¼š
   - `WebGLImageViewerProps` æ–°å¢ `width?` å’Œ `height?` å±æ€§
   - `ProgressiveImage` ç»„ä»¶ä¼ é€’è¿™äº›å‚æ•°
   - `PhotoViewer` ä½¿ç”¨ç…§ç‰‡çš„åŸå§‹å°ºå¯¸ `currentPhoto.width/height`

### ä¼˜åŒ–æ•ˆæœï¼š

1. **æ›´å¿«çš„è§†å£è®¾ç½®**ï¼šæä¾›å°ºå¯¸åå¯ç«‹å³è®¾ç½®æ­£ç¡®çš„ç¼©æ”¾å’Œæ¸²æŸ“ç­–ç•¥
2. **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·å¯ä»¥æ›´æ—©çœ‹åˆ°æ­£ç¡®çš„è§†å£ï¼Œä¸éœ€è¦ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
3. **å¹¶è¡ŒåŠ è½½**ï¼šå›¾ç‰‡æ•°æ®åŠ è½½ä¸æ¸²æŸ“ç®¡é“å‡†å¤‡å¹¶è¡Œè¿›è¡Œ
4. **å‘åå…¼å®¹**ï¼šä¸æä¾›å°ºå¯¸æ—¶ä»æŒ‰åŸæµç¨‹å·¥ä½œ

è¿™ä¸ªä¼˜åŒ–ç‰¹åˆ«é€‚ç”¨äºç…§ç‰‡ç”»å»Šåœºæ™¯ï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸åœ¨manifestä¸­å·²ç»æœ‰äº†å›¾ç‰‡çš„å°ºå¯¸ä¿¡æ¯ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…ç­‰å¾…å›¾ç‰‡åŠ è½½æ‰èƒ½è®¾ç½®WebGLæ¸²æŸ“å™¨çš„å»¶è¿Ÿã€‚

---

_**User**_

canvas çš„ç¼©æ”¾ä¸æ­£ç¡®äº†ï¼Œç°åœ¨åˆå§‹æ¸²æŸ“çš„ä¸æ˜¯ fit-screen çš„å†…å®¹ï¼Œè€Œä¸”è¿˜ä¼šé—ªå‡ ä¸‹

---

_**Assistant**_



---

æˆ‘çœ‹åˆ°é—®é¢˜äº†ï¼å½“æä¾›é¢„çŸ¥å°ºå¯¸æ—¶ï¼Œæˆ‘ä»¬ç§»é™¤äº†ç¼©æ”¾è®¾ç½®ï¼Œè¿™å¯¼è‡´canvasæ²¡æœ‰æ­£ç¡®çš„åˆå§‹ç¼©æ”¾ã€‚è®©æˆ‘ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š

---



---

è®©æˆ‘å…ˆè¯»å–å½“å‰æ–‡ä»¶å†…å®¹ï¼š

---

Read file: packages/webgl-viewer/src/WebGLImageViewerEngine.ts

---

ç°åœ¨æˆ‘çœ‹åˆ°äº†é—®é¢˜ã€‚å½“æä¾›é¢„çŸ¥å°ºå¯¸æ—¶ï¼Œæˆ‘ä»¬ç§»é™¤äº†`setupInitialScaling()`è°ƒç”¨ï¼Œè¿™å¯¼è‡´ç¼©æ”¾æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®ã€‚è®©æˆ‘ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”æ·»åŠ ä¸€ä¸ªæ ‡å¿—æ¥é¿å…é‡å¤è®¾ç½®ï¼š

---



---

ç°åœ¨ä¿®å¤loadImageæ–¹æ³•çš„é€»è¾‘ï¼š

---



---

ç°åœ¨ä¿®å¤image.onloadä¸­çš„é€»è¾‘ï¼Œé¿å…é‡å¤è®¾ç½®ç¼©æ”¾ï¼š

---



---

æœ€åï¼Œåœ¨destroyæ–¹æ³•ä¸­é‡ç½®è¿™ä¸ªæ ‡å¿—ï¼š

---



---

ç°åœ¨çš„ä¼˜åŒ–ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

## ä¿®å¤æ€»ç»“

### é—®é¢˜åŸå› ï¼š
1. **ç¼©æ”¾æœªè®¾ç½®**ï¼šå½“æä¾›é¢„çŸ¥å°ºå¯¸æ—¶ï¼Œæˆ‘ä»¬ç§»é™¤äº†`setupInitialScaling()`è°ƒç”¨ï¼Œå¯¼è‡´canvasæ²¡æœ‰æ­£ç¡®çš„åˆå§‹ç¼©æ”¾
2. **æ—¶åºé—®é¢˜**ï¼šç¼©æ”¾è®¾ç½®è¢«å»¶è¿Ÿåˆ°å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œé€ æˆäº†åˆå§‹æ¸²æŸ“çš„ä¸æ­£ç¡®å’Œé—ªçƒ

### ä¿®å¤æªæ–½ï¼š

1. **ç«‹å³è®¾ç½®ç¼©æ”¾**ï¼š
   ```typescript
   if (preknownWidth && preknownHeight) {
     // ç«‹å³è®¾ç½®æ­£ç¡®çš„ç¼©æ”¾å’Œæ¸²æŸ“ç­–ç•¥
     this.setupInitialScaling()
     this.scalingAlreadySet = true // æ ‡è®°ç¼©æ”¾å·²è®¾ç½®
     this.determineRenderingStrategy()
   }
   ```

2. **é¿å…é‡å¤è®¾ç½®**ï¼š
   - æ·»åŠ `scalingAlreadySet`æ ‡å¿—é˜²æ­¢é‡å¤è®¾ç½®ç¼©æ”¾
   - åªæœ‰åœ¨ç¼©æ”¾æœªè®¾ç½®æˆ–å°ºå¯¸ä¸åŒ¹é…æ—¶æ‰é‡æ–°è®¾ç½®

3. **ä¿æŒå…¼å®¹æ€§**ï¼š
   - æ²¡æœ‰é¢„çŸ¥å°ºå¯¸æ—¶ä»æŒ‰åŸæµç¨‹å·¥ä½œ
   - å°ºå¯¸ä¸åŒ¹é…æ—¶ä¼šé‡æ–°è®¾ç½®æ­£ç¡®çš„ç¼©æ”¾

### ä¼˜åŒ–æ•ˆæœï¼š

1. **æ¶ˆé™¤é—ªçƒ**ï¼šç«‹å³è®¾ç½®æ­£ç¡®çš„ç¼©æ”¾ï¼Œé¿å…æ¸²æŸ“æ—¶çš„å°ºå¯¸è·³å˜
2. **æ­£ç¡®çš„fit-screen**ï¼šç¡®ä¿åˆå§‹æ¸²æŸ“å°±æ˜¯æ­£ç¡®çš„é€‚åº”å±å¹•ç¼©æ”¾
3. **æ›´å¥½çš„æ€§èƒ½**ï¼šé¿å…é‡å¤çš„ç¼©æ”¾è®¡ç®—å’Œè®¾ç½®
4. **ç»´æŒä¼˜åŒ–**ï¼šä¿æŒå¹¶è¡ŒåŠ è½½çš„æ€§èƒ½ä¼˜åŠ¿

ç°åœ¨canvasåº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºfit-screençš„åˆå§‹çŠ¶æ€ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰é—ªçƒé—®é¢˜äº†ã€‚

---


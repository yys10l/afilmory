<!-- Generated by SpecStory -->

# é«˜æ€§èƒ½ HEIC/HEIF å›¾ç‰‡æ¸²æŸ“æ–¹æ¡ˆ (2025-05-26 13:52:09)

_**User**_

ä½¿ç”¨ é«˜æ€§èƒ½çš„æµè§ˆå™¨æ–¹æ¡ˆ æ¸²æŸ“ heic heif å›¾ç‰‡ , è½¬æ¢å¯èƒ½éœ€è¦ wasm åº“ã€‚é¦–å…ˆè¿˜æ˜¯ä¸‹è½½å›¾ç‰‡ï¼Œç„¶åå§ buffer è½¬æ¢ï¼Œå€ŸåŠ© blob å»åŠ è½½å›¾ç‰‡

---

_**Assistant**_

æˆ‘æ¥å¸®ä½ å®ç°é«˜æ€§èƒ½çš„ HEIC/HEIF å›¾ç‰‡æ¸²æŸ“æ–¹æ¡ˆã€‚é¦–å…ˆæˆ‘éœ€è¦æœç´¢ä¸€ä¸‹ç°æœ‰çš„ WASM åº“æ¥å¤„ç† HEIC/HEIF æ ¼å¼è½¬æ¢ã€‚

---

<details>
            <summary>Searched web "HEIC HEIF to JPEG WebAssembly library browser 2024" â€¢ **5** results</summary>
        
| Title | URL |
|-------|-----|
| HEIC.online: Convert HEIC to JPG | https://heic.online/ |
| Handling HEIC on the web \| Blog | https://upsidelab.io/blog/handling-heic-on-the-web |
| GitHub - hoppergee/heic-to: Convert HEIC/HEIF images to JPEG, PNG in browser | https://github.com/hoppergee/heic-to |
| ffmpeg.wasm \| ffmpeg.wasm | https://ffmpegwasm.netlify.app/ |
| GitHub - Trzcin/convert-it-all: Easily convert between file formats. Provides a cli and a web interface using WebAssembly. | https://github.com/Trzcin/convert-it-all |

</details>

---

ç°åœ¨è®©æˆ‘æœç´¢ä¸€äº›ä¸“é—¨çš„ HEIC/HEIF WASM åº“ï¼š

---

<details>
            <summary>Searched web "heic-to libheif-js heic2any WASM library comparison 2024" â€¢ **5** results</summary>
        
| Title | URL |
|-------|-----|
| Handling HEIC on the web \| Blog | https://upsidelab.io/blog/handling-heic-on-the-web |
| Unable to convert heic to jpg taken by iPhone 15 pro iOS18 | https://github.com/strukturag/libheif/issues/1190 |
| GitHub - hoppergee/heic-to: Convert HEIC/HEIF images to JPEG, PNG in browser | https://github.com/hoppergee/heic-to |
| High Efficiency Image File Format | https://en.wikipedia.org/wiki/Libheif |
| Handling HEIC on the web \| Blog \| Upside | https://upsidelab.io/blog/handling-heic-on-the-web |

</details>

---

åŸºäºæˆ‘çš„ç ”ç©¶ï¼Œæˆ‘ç°åœ¨æ¥ä¸ºä½ å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ HEIC/HEIF å›¾ç‰‡æ¸²æŸ“æ–¹æ¡ˆã€‚æˆ‘å°†ä½¿ç”¨ `heic-to` åº“ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäºæœ€æ–° libheif 1.19.8 çš„ç°ä»£åŒ– WASM åº“ï¼Œä¸“é—¨ä¸ºæµè§ˆå™¨ä¼˜åŒ–ã€‚

é¦–å…ˆï¼Œè®©æˆ‘å®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

---

```bash
cd /Users/innei/git/vibe-coding/photo-gallery-site && npm install heic-to
```

```
be-coding/photo-gallery-site && npm install heic-to       cd /Users/innei/git/vibe-coding/photo-gallery-site    npm
â€‰WARNâ€‰ 2 deprecated subdependencies found: glob@7.2.3, inflight@1.0.6
Packages: +1
+
Progress: resolved 887, reused 777, downloaded 1, added 1, done

dependencies:
+ heic-to 1.1.13
- heic2any 0.0.4

Done in 5.8s using pnpm v10.11.0

innei in photo-gallery-site on î‚  main [$!â‡¡1] via ğŸ v0.0.1 via îœ˜ v22.15.0 on â˜ï¸  innei@rss3.io at ïˆ  ï…¹ îœ© f88a4a0 "Upd
ate background color in ProgressiveImage component for improved styling consistency"  by tukon479@gmail.com took 5s 
at 13:53:34 â¯
```

---

ç°åœ¨è®©æˆ‘åˆ›å»ºä¸€ä¸ªä¸“é—¨å¤„ç† HEIC/HEIF å›¾ç‰‡çš„å·¥å…·å‡½æ•°ï¼š

---

```diff
- 
+ import { heicTo, isHeic } from 'heic-to'
+ 
+ export interface HeicConversionOptions {
+   quality?: number
+   format?: 'image/jpeg' | 'image/png'
+ }
+ 
+ export interface ConversionResult {
+   blob: Blob
+   url: string
+   originalSize: number
+   convertedSize: number
+   format: string
+ }
+ 
+ /**
+  * æ£€æµ‹æ–‡ä»¶æ˜¯å¦ä¸º HEIC/HEIF æ ¼å¼
+  */
+ export async function detectHeicFormat(file: File | Blob): Promise<boolean> {
+   try {
+     return await isHeic(file)
+   } catch (error) {
+     console.warn('Failed to detect HEIC format:', error)
+     return false
+   }
+ }
+ 
+ /**
+  * å°† HEIC/HEIF å›¾ç‰‡è½¬æ¢ä¸º JPEG æˆ– PNG
+  */
+ export async function convertHeicImage(
+   file: File | Blob,
+   options: HeicConversionOptions = {}
+ ): Promise<ConversionResult> {
+   const { quality = 0.8, format = 'image/jpeg' } = options
+ 
+   try {
+     // æ£€æŸ¥æ˜¯å¦ä¸º HEIC æ ¼å¼
+     const isHeicFormat = await detectHeicFormat(file)
+     if (!isHeicFormat) {
+       throw new Error('File is not in HEIC/HEIF format')
+     }
+ 
+     // è½¬æ¢å›¾ç‰‡
+     const convertedBlob = await heicTo({
+       blob: file,
+       type: format,
+       quality,
+     })
+ 
+     // åˆ›å»º URL
+     const url = URL.createObjectURL(convertedBlob)
+ 
+     return {
+       blob: convertedBlob,
+       url,
+       originalSize: file.size,
+       convertedSize: convertedBlob.size,
+       format,
+     }
+   } catch (error) {
+     console.error('HEIC conversion failed:', error)
+     throw new Error(`Failed to convert HEIC image: ${error instanceof Error ? error.message : 'Unknown error'}`)
+   }
+ }
+ 
+ /**
+  * æ¸…ç†è½¬æ¢åçš„ URL
+  */
+ export function revokeConvertedUrl(url: string): void {
+   try {
+     URL.revokeObjectURL(url)
+   } catch (error) {
+     console.warn('Failed to revoke URL:', error)
+   }
+ }
+ 
+ /**
+  * è·å–æ–‡ä»¶çš„ MIME ç±»å‹
+  */
+ export function getFileMimeType(file: File): string {
+   return file.type || 'application/octet-stream'
+ }
+ 
+ /**
+  * æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯èƒ½æ˜¯ HEIC æ ¼å¼ï¼ˆåŸºäºæ‰©å±•åï¼‰
+  */
+ export function isPotentialHeicFile(file: File): boolean {
+   const fileName = file.name.toLowerCase()
+   return fileName.endsWith('.heic') || fileName.endsWith('.heif')
+ }
+ 
+ /**
+  * æ‰¹é‡è½¬æ¢ HEIC å›¾ç‰‡
+  */
+ export async function convertMultipleHeicImages(
+   files: (File | Blob)[],
+   options: HeicConversionOptions = {},
+   onProgress?: (completed: number, total: number) => void
+ ): Promise<ConversionResult[]> {
+   const results: ConversionResult[] = []
+   
+   for (let i = 0; i < files.length; i++) {
+     try {
+       const result = await convertHeicImage(files[i], options)
+       results.push(result)
+     } catch (error) {
+       console.error(`Failed to convert file ${i}:`, error)
+       // ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
+     }
+     
+     onProgress?.(i + 1, files.length)
+   }
+   
+   return results
+ } 
```

---

è®©æˆ‘ä¿®å¤ç±»å‹é”™è¯¯ï¼š

---



---

ç°åœ¨è®©æˆ‘æ›´æ–° ProgressiveImage ç»„ä»¶æ¥æ”¯æŒ HEIC/HEIF æ ¼å¼ï¼š

---



---

ç°åœ¨è®©æˆ‘æ›´æ–° ProgressiveImage ç»„ä»¶çš„çŠ¶æ€å’Œé€»è¾‘æ¥å¤„ç† HEIC è½¬æ¢ï¼š

---



---

ç°åœ¨è®©æˆ‘æ›´æ–°é‡ç½®çŠ¶æ€çš„ useEffectï¼š

---



---

ç°åœ¨è®©æˆ‘æ›´æ–°ä¸»è¦çš„å›¾ç‰‡åŠ è½½é€»è¾‘æ¥å¤„ç† HEIC æ ¼å¼ï¼š

---



---

è®©æˆ‘ä¿®å¤ linter é”™è¯¯ï¼Œæ›´æ–°åŠ è½½æŒ‡ç¤ºå™¨æ¥æ˜¾ç¤ºè½¬æ¢çŠ¶æ€ï¼š

---



---



---

ç°åœ¨è®©æˆ‘æ›´æ–°åŠ è½½æŒ‡ç¤ºå™¨æ¥æ˜¾ç¤º HEIC è½¬æ¢çŠ¶æ€ï¼š

---



---

ç°åœ¨è®©æˆ‘æ·»åŠ ä¸€ä¸ªæ¸…ç†å‡½æ•°æ¥å¤„ç†ç»„ä»¶å¸è½½æ—¶çš„ URL æ¸…ç†ï¼š

---



---

ç°åœ¨è®©æˆ‘åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•é¡µé¢æ¥éªŒè¯ HEIC æ”¯æŒï¼š

---

Cancelled

---

_**User**_

è¿™ä¸ªä¼šå¯¼è‡´æ— çº¿ convert

---

_**Assistant**_

ä½ è¯´å¾—å¯¹ï¼è¿™é‡Œç¡®å®ä¼šå¯¼è‡´æ— é™å¾ªç¯ã€‚é—®é¢˜åœ¨äº `useEffect` çš„ä¾èµ–æ•°ç»„ä¸­åŒ…å«äº† `convertedUrl`ï¼Œè€Œåœ¨ effect å†…éƒ¨åˆä¼šä¿®æ”¹ `convertedUrl`ï¼Œè¿™ä¼šè§¦å‘æ–°çš„ effect æ‰§è¡Œã€‚

è®©æˆ‘ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š

---



---

ç°åœ¨è®©æˆ‘ä¹Ÿä¼˜åŒ–ä¸€ä¸‹æ¸…ç†é€»è¾‘ï¼Œä½¿ç”¨ `useRef` æ¥è·Ÿè¸ªå½“å‰çš„ URLï¼Œé¿å…åœ¨ä¾èµ–æ•°ç»„ä¸­åŒ…å«çŠ¶æ€ï¼š

---



---

ç°åœ¨è®©æˆ‘æ›´æ–°é‡ç½®é€»è¾‘æ¥ä½¿ç”¨ refï¼š

---



---

ç°åœ¨è®©æˆ‘æ›´æ–°è½¬æ¢é€»è¾‘æ¥ä½¿ç”¨ refï¼š

---



---

ç°åœ¨è®©æˆ‘æ›´æ–°ç»„ä»¶å¸è½½æ—¶çš„æ¸…ç†é€»è¾‘ï¼š

---



---

è®©æˆ‘ç§»é™¤æœªä½¿ç”¨çš„ `convertedUrl` çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨ ref æ¥ç®¡ç†ï¼š

---



---

è®©æˆ‘ç§»é™¤å¯¹ `setConvertedUrl` çš„è°ƒç”¨ï¼š

---



---



---

ç°åœ¨è®©æˆ‘åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ç»„ä»¶æ¥éªŒè¯ HEIC æ”¯æŒï¼š

---

Cancelled

---


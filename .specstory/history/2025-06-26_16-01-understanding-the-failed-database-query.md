<!-- Generated by SpecStory -->

# Understanding the failed database query (2025-06-27 00:01:18)

_**User**_

   "err": {
                    "name": "Error",
                    "source": "edge-server",
                    "message": "Failed query: insert into \"reactions\" (\"id\", \"created_at\", \"ref_key\", \"reaction\") values (default, default, $1, $2)\nparams: DSCF4086,ğŸ˜",
                    "stack": "Error: Failed query: insert into \"reactions\" (\"id\", \"created_at\", \"ref_key\", \"reaction\") values (default, default, $1, $2)\nparams: DSCF4086,ğŸ˜\n    at PostgresJsPreparedQuery.queryWithCache (file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/ssr/.next/server/edge/chunks/fd5db_drizzle-orm_a84ac793._.js:8547:23)\n    at async (file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/ssr/.next/server/edge/chunks/[root-of-the-server]__dc003707._.js:259:5)\n    at async AppRouteRouteModule.do (file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/ssr/.next/server/edge/chunks/69ea6_next_dist_esm_ab019168._.js:12275:23)\n    at async AppRouteRouteModule.handle (file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/ssr/.next/server/edge/chunks/69ea6_next_dist_esm_ab019168._.js:12370:26)\n    at async EdgeRouteModuleWrapper.handler (file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/ssr/.next/server/edge/chunks/69ea6_next_dist_esm_ab019168._.js:8726:19)\n    at async adapter (file:///Users/innei/git/vibe-coding/photo-gallery-site/apps/ssr/.next/server/edge/chunks/69ea6_next_dist_esm_ab019168._.js:4352:16)\n    at async (file:///Users/innei/git/vibe-coding/photo-gallery-site/node_modules/.pnpm/next@15.3.4_@babel+core@7.27.1_babel-plugin-react-compiler@19.1.0-rc.2_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/sandbox/sandbox.js:108:26)\n    at async runWithTaggedErrors (file:///Users/innei/git/vibe-coding/photo-gallery-site/node_modules/.pnpm/next@15.3.4_@babel+core@7.27.1_babel-plugin-react-compiler@19.1.0-rc.2_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/sandbox/sandbox.js:105:9)\n    at async DevServer.runEdgeFunction (file:///Users/innei/git/vibe-coding/photo-gallery-site/node_modules/.pnpm/next@15.3.4_@babel+core@7.27.1_babel-plugin-react-compiler@19.1.0-rc.2_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/next-server.js:1305:24)\n    at async NextNodeServer.handleCatchallRenderRequest (file:///Users/innei/git/vibe-coding/photo-gallery-site/node_modules/.pnpm/next@15.3.4_@babel+core@7.27.1_babel-plugin-react-compiler@19.1.0-rc.2_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/next-server.js:273:41)"
                },

ä¸ºä»€ä¹ˆå¤±è´¥äº†

---

_**Assistant**_



---

ä½ å¥½ï¼Œè¿™ä¸ªé”™è¯¯æ—¥å¿—æ˜¾ç¤ºå‘ `reactions` è¡¨ä¸­æ’å…¥æ•°æ®å¤±è´¥äº†ã€‚

`Failed query: insert into "reactions" ("id", "created_at", "ref_key", "reaction") values (default, default, $1, $2)\nparams: DSCF4086,ğŸ˜`

è¿™ä¸ªé”™è¯¯é€šå¸¸ä¸æ˜¯ç”±ä»£ç é€»è¾‘ç›´æ¥å¼•èµ·çš„ï¼Œè€Œæ˜¯æ•°æ®åº“å±‚é¢çš„é—®é¢˜ã€‚ä» Drizzle ORM ç”Ÿæˆçš„ SQL è¯­å¥æ¥çœ‹ï¼Œå®ƒæ­£åœ¨å°è¯•æ’å…¥ `ref_key` å’Œ `reaction`ã€‚

å¤±è´¥çš„å¯èƒ½åŸå› æœ‰ï¼š

1.  **æ•°æ®åº“è¿æ¥é—®é¢˜**ï¼šServerless ç¯å¢ƒï¼ˆä¾‹å¦‚ Vercel Edgeï¼‰çš„ IP åœ°å€ç»å¸¸å˜åŒ–ï¼Œå¦‚æœä½ çš„æ•°æ®åº“æœåŠ¡å•†ï¼ˆå¦‚ Vercel Postgresï¼‰æœ‰ IP ç™½åå•é™åˆ¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿æ¥å¤±è´¥ã€‚
2.  **æ•°æ®ç±»å‹ä¸åŒ¹é…**ï¼š`reaction` åˆ—çš„ç±»å‹å¯èƒ½ä¸æ’å…¥çš„ emoji `ğŸ˜` ä¸å…¼å®¹ã€‚
3.  **çº¦æŸå†²çª**ï¼šä¾‹å¦‚ `ref_key` å­—æ®µæœ‰å”¯ä¸€æ€§çº¦æŸï¼Œè€Œ `DSCF4086` è¿™ä¸ªå€¼å¯èƒ½å·²ç»å­˜åœ¨äºè¡¨ä¸­äº†ã€‚

ä¸ºäº†å®šä½é—®é¢˜ï¼Œæˆ‘éœ€è¦æŸ¥çœ‹ `reactions` è¡¨çš„ç»“æ„ã€‚æˆ‘ç°åœ¨å°±å»æŸ¥æ‰¾å¹¶è¯»å–ç›¸å…³çš„ schema æ–‡ä»¶ã€‚

---

<details>
            <summary>Searched codebase "apps/ssr/src/schemas/reaction.ts" â€¢ **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---



---

å¥½çš„ï¼Œæˆ‘å·²ç»æ‰¾åˆ°äº† schema æ–‡ä»¶çš„ä½ç½®ï¼Œç°åœ¨æ¥è¯»å–å®ƒã€‚

---

Read file: apps/ssr/src/schemas/reaction.ts

---



---

å¥½çš„ï¼Œæˆ‘å·²ç»æ‹¿åˆ°äº† `reactions` è¡¨çš„ schemaã€‚

```typescript
export const reactions = pgTable(
  'reactions',
  {
    id: text('id')
      .primaryKey()
      .default(sql`gen_random_uuid()`),
    createdAt: timestamp('created_at').defaultNow(),
    refKey: varchar('ref_key', { length: 120 }).notNull(),
    reaction: varchar('reaction', { length: 20 }).notNull(),
  },
  (t) => [index('reaction_ref_key_idx').on(t.refKey)],
)
```

æ ¹æ® schemaï¼Œ`refKey` æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 120 çš„ `varchar`ï¼Œ`reaction` æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 20 çš„ `varchar`ã€‚ä½ ä¼ å…¥çš„å‚æ•° `'DSCF4086'` å’Œ `'ğŸ˜'` éƒ½åœ¨è¿™ä¸ªé™åˆ¶èŒƒå›´å†…ï¼Œæ‰€ä»¥ç±»å‹ä¸åŒ¹é…çš„å¯èƒ½æ€§ä¸å¤§ã€‚

ä»£ç ä¸­ä¹Ÿæ²¡æœ‰ä¸º `refKey` è®¾ç½®å”¯ä¸€çº¦æŸï¼ˆ`unique()`ï¼‰ï¼Œæ‰€ä»¥é‡å¤é”®å¯¼è‡´é”™è¯¯çš„æ¦‚ç‡ä¹Ÿè¾ƒä½ï¼Œé™¤éæ•°æ®åº“ä¸­çš„è¡¨ç»“æ„å’Œè¿™ä»½ schema æ–‡ä»¶ä¸ä¸€è‡´ã€‚

æœ€å¯èƒ½çš„åŸå› æ˜¯ **æ•°æ®åº“è¿æ¥é—®é¢˜**ã€‚

ä½ çš„ API è¿è¡Œåœ¨ Edge ç¯å¢ƒ (`runtime = 'edge'`)ï¼Œå®ƒçš„ IP åœ°å€æ˜¯ä¸å›ºå®šçš„ã€‚å¦‚æœä½ çš„æ•°æ®åº“ï¼ˆæ¯”å¦‚ Vercel Postgresï¼‰é…ç½®äº† IP ç™½åå•ï¼ŒEdge Function çš„è¯·æ±‚å¯èƒ½ä¼šå› ä¸ºæ¥æº IP ä¸åœ¨ç™½åå•å†…è€Œè¢«æ‹’ç»ï¼Œä»è€Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚`postgres.js` é©±åŠ¨å¯èƒ½æ²¡æœ‰è¿”å›ä¸€ä¸ªæ˜ç¡®çš„è¿æ¥é”™è¯¯ï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªé€šç”¨çš„ "Failed query" æ¶ˆæ¯å±•ç°å‡ºæ¥ã€‚

**æˆ‘å»ºè®®ä½ ï¼š**

æ£€æŸ¥ä¸€ä¸‹ä½ çš„æ•°æ®åº“æä¾›å•†çš„åå°ï¼Œç¡®è®¤æ˜¯å¦å…è®¸äº†æ¥è‡ªæ‰€æœ‰ IP åœ°å€çš„è¿æ¥ï¼ˆé€šå¸¸è®¾ç½®ä¸º `0.0.0.0/0`ï¼‰ã€‚è¿™å¯¹äº Serverless/Edge å‡½æ•°æ˜¯å¿…è¦çš„ã€‚

å¦å¤–ï¼Œä¸ºäº†è®©ç¨‹åºåœ¨å‘ç”Ÿé”™è¯¯æ—¶èƒ½è¿”å›æ›´æ˜ç¡®çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª 500 é”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `try...catch` æŠŠæ•°æ®åº“æ“ä½œåŒ…èµ·æ¥ï¼Œå¹¶åœ¨å‡ºé”™æ—¶è¿”å›ä¸€ä¸ªå¸¦æœ‰å…·ä½“é”™è¯¯ä¿¡æ¯çš„ JSON Responseã€‚

ä½ æƒ³è®©æˆ‘å¸®ä½ ä¿®æ”¹ `apps/ssr/src/app/api/reactions/route.ts` æ–‡ä»¶ï¼Œæ·»åŠ  `try...catch` é”™è¯¯å¤„ç†å—ï¼Ÿ

---

<details>
            <summary>Searched codebase "apps/ssr/src/app/api/reactions/dto.ts" â€¢ **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---



---

å¥½äº†ï¼ŒDTO æ–‡ä»¶çš„è·¯å¾„å·²æ‰¾åˆ°ã€‚è¿™å°±å»è¯»å–å¹¶æ£€æŸ¥å®ƒçš„éªŒè¯é€»è¾‘ã€‚

---

Read file: apps/ssr/src/app/api/reactions/dto.ts

---



---

å¥½çš„ã€‚`ReactionDto` çš„ `zod` schema éªŒè¯äº†æ•°æ®åœ¨è¿›å…¥æ•°æ®åº“å‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™è®©æˆ‘æ›´åŠ ç¡®ä¿¡é—®é¢˜å‡ºåœ¨æ•°æ®åº“æ“ä½œæœ¬èº«ï¼Œå¾ˆå¯èƒ½æ˜¯ç½‘ç»œè¿æ¥é—®é¢˜ã€‚

æˆ‘ç°åœ¨å°†ä¸º `apps/ssr/src/app/api/reactions/route.ts` ä¸­çš„ `POST` è¯·æ±‚å¤„ç†å‡½æ•°æ·»åŠ  `try...catch` å—ã€‚è¿™æ ·ä¸ä»…å¯ä»¥é˜²æ­¢æœåŠ¡å´©æºƒï¼Œè¿˜èƒ½åœ¨å‡ºé”™æ—¶è¿”å›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚

---

```diff
  import type { NextRequest } from 'next/server'
+ import { NextResponse } from 'next/server'
  
  import { guardDbEnabled } from '~/lib/api-guard'
```

```diff
  export const runtime = 'edge'
  export const POST = guardDbEnabled(async (req: NextRequest) => {
-   const { refKey, reaction } = ReactionDto.parse(await req.json())
+   try {
+     const { refKey, reaction } = ReactionDto.parse(await req.json())
  
-   const db = DbManager.shared.getDb()
+     const db = DbManager.shared.getDb()
  
-   await db.insert(reactions).values({
-     refKey,
-     reaction,
-   })
+     await db.insert(reactions).values({
+       refKey,
+       reaction,
+     })
+ 
+     return NextResponse.json({ message: 'Reaction added' }, { status: 201 })
+   } catch (error) {
+     console.error('Failed to add reaction:', error)
+     return NextResponse.json(
+       { message: 'Failed to add reaction', error: (error as Error).message },
+       { status: 500 },
+     )
+   }
  })
  
```

---



---

`try...catch` ä»£ç å—å·²ç»æˆåŠŸæ·»åŠ ï¼Œè¿™ä¼šä¼˜åŒ–é”™è¯¯å¤„ç†æµç¨‹ã€‚

æˆ‘å·²ç»è§£é‡Šäº†æœ€å¯èƒ½çš„å¤±è´¥åŸå› ï¼ˆServerless ç¯å¢ƒä¸‹çš„æ•°æ®åº“è¿æ¥é—®é¢˜ï¼‰ï¼Œå¹¶é€šè¿‡ä»£ç ä¿®æ”¹æä¾›äº†æ›´å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚

å¯¹äºä½ æœ€åˆçš„é—®é¢˜â€œä¸ºä»€ä¹ˆå¤±è´¥äº†ï¼Ÿâ€ï¼Œæˆ‘å·²ç»ç»™å‡ºäº†æˆ‘çš„åˆ†æå’Œè§£å†³æ–¹æ¡ˆã€‚å¦‚æœä½ è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œéšæ—¶å¯ä»¥æå‡ºã€‚

---


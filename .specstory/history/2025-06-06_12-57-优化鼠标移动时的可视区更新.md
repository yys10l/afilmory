<!-- Generated by SpecStory -->

# ä¼˜åŒ–é¼ æ ‡ç§»åŠ¨æ—¶çš„å¯è§†åŒºæ›´æ–° (2025-06-06 20:57:16)

_**User**_

é¼ æ ‡ç§»åŠ¨æ”¹å˜å¯è§†åŒºçš„æ—¶å€™ updateTiles è¿˜æ˜¯å¤ªå¡äº†

---

_**Assistant**_

ä»é™„å›¾çš„æ€§èƒ½åˆ†æå’Œä»£ç æ¥çœ‹ï¼Œ`updateVisibleTiles` åœ¨é¼ æ ‡ç§»åŠ¨æ—¶ç¡®å®å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚æˆ‘çœ‹åˆ° `createTileTextureWithWorker` è€—æ—¶ 216.77msï¼Œè¿™ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚è®©æˆ‘åˆ†æå¹¶ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ï¼š

---

<details>
            <summary>Searched codebase "updateVisibleTiles createTileTexture performance optimization" â€¢ **25** results</summary>
        
| File | Lines |
|------|-------|
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L804-823 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L788-804 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1080-1141 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1485-1550 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1141-1184 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1223-1248 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L2602-2628 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L2647-2678 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L823-860 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L89-139 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1031-1080 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1248-1308 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1782-1800 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1424-1485 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L2346-2368 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L690-729 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1308-1344 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1344-1391 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1550-1587 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1391-1424 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L2738-2785 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L894-945 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L562-573 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L1800-1852 |
| `packages/webgl-viewer/src/WebGLImageViewerEngine.ts` | L860-894 |

</details>

---

ç°åœ¨æˆ‘æ¥åˆ†æé—®é¢˜å¹¶è¿›è¡Œä¼˜åŒ–ã€‚ä»æ€§èƒ½åˆ†æå›¾å¯ä»¥çœ‹åˆ° `createTileTextureWithWorker` è€—æ—¶216.77msï¼Œè¿™è¡¨æ˜ç“¦ç‰‡åˆ›å»ºè¿‡ç¨‹ä»ç„¶åœ¨é˜»å¡ä¸»çº¿ç¨‹ã€‚ä¸»è¦é—®é¢˜åŒ…æ‹¬ï¼š

1. **è¿‡äºé¢‘ç¹çš„ç“¦ç‰‡è®¡ç®—**: é¼ æ ‡ç§»åŠ¨æ—¶é¢‘ç¹è®¡ç®—å¯è§ç“¦ç‰‡
2. **Workeråˆ›å»ºç“¦ç‰‡æ—¶çš„ä¸»çº¿ç¨‹é˜»å¡**: createImageBitmap å’Œçº¹ç†ä¸Šä¼ ä»ç„¶åœ¨ä¸»çº¿ç¨‹
3. **ç¼ºä¹æœ‰æ•ˆçš„ç¼“å­˜å’Œå»é‡æœºåˆ¶**: é‡å¤åˆ›å»ºç›¸åŒç“¦ç‰‡

è®©æˆ‘å®æ–½ä¸€å¥—å…¨é¢çš„ä¼˜åŒ–æ–¹æ¡ˆï¼š

---

```diff
    private memoryPressureThreshold = 0.8 // 80% å†…å­˜ä½¿ç”¨ç‡è§¦å‘æ¸…ç†
    private maxConcurrentLODs = 1 // åªä¿ç•™å½“å‰éœ€è¦çš„ä¸€ä¸ªLOD
+ 
+   // ç“¦ç‰‡æ›´æ–°ä¼˜åŒ–ç¼“å­˜
+   private lastViewportKey = '' // ä¸Šæ¬¡è§†å£çš„ç¼“å­˜key
+   private viewportChangeThreshold = 20 // è§†å£å˜åŒ–é˜ˆå€¼(åƒç´ )
+   private tileCalculationCache = new Map<string, Set<string>>() // è§†å£key -> ç“¦ç‰‡é›†åˆ
+   private pendingTileUpdates = new Set<string>() // å¾…å¤„ç†çš„ç“¦ç‰‡æ›´æ–°
+   private tileUpdateBatchId: number | null = null
+   private isTileUpdateInProgress = false // æ˜¯å¦æ­£åœ¨è¿›è¡Œç“¦ç‰‡æ›´æ–°
  
    constructor(
```

---

```diff
  
    private updateVisibleTiles() {
-     if (!this.originalImage || !this.useTiledRendering) return
+     if (!this.originalImage || !this.useTiledRendering || this.isTileUpdateInProgress) return
  
-     // è®¡ç®—å½“å‰è§†å£åœ¨å›¾ç‰‡åæ ‡ç³»ä¸­çš„ä½ç½®
+     // è®¡ç®—å½“å‰è§†å£çš„ç¼“å­˜key
      const viewport = this.calculateViewport()
- 
+     const currentViewportKey = this.calculateViewportKey(viewport)
+     
+     // æ£€æŸ¥è§†å£æ˜¯å¦æœ‰æ˜¾è‘—å˜åŒ–
+     if (this.lastViewportKey && this.isViewportSimilar(currentViewportKey, this.lastViewportKey)) {
+       // è§†å£å˜åŒ–ä¸å¤§ï¼Œè·³è¿‡æ›´æ–°
+       return
+     }
+ 
+     // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰ç›¸ä¼¼çš„è§†å£é…ç½®
+     const cachedTiles = this.tileCalculationCache.get(currentViewportKey)
+     if (cachedTiles) {
+       // ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ç“¦ç‰‡é…ç½®
+       this.activeTiles = new Set(cachedTiles)
+       this.loadRequiredTiles()
+       this.lastViewportKey = currentViewportKey
+       return
+     }
+ 
+     // æ ‡è®°æ­£åœ¨è¿›è¡Œç“¦ç‰‡æ›´æ–°
+     this.isTileUpdateInProgress = true
+ 
+     try {
        // è®¡ç®—éœ€è¦çš„ç“¦ç‰‡èŒƒå›´
        const tileRange = this.calculateTileRange(viewport)
  
        // æ›´æ–°æ´»è·ƒç“¦ç‰‡é›†åˆ
-     this.updateActiveTiles(tileRange)
+       this.updateActiveTiles(tileRange, viewport)
+ 
+       // ç¼“å­˜è¿™æ¬¡çš„è®¡ç®—ç»“æœ
+       this.tileCalculationCache.set(currentViewportKey, new Set(this.activeTiles))
+       
+       // é™åˆ¶ç¼“å­˜å¤§å°
+       if (this.tileCalculationCache.size > 20) {
+         const firstKey = this.tileCalculationCache.keys().next().value
+         this.tileCalculationCache.delete(firstKey)
+       }
  
        // å¼‚æ­¥åŠ è½½éœ€è¦çš„ç“¦ç‰‡
        this.loadRequiredTiles()
+       
+       this.lastViewportKey = currentViewportKey
+     } finally {
+       this.isTileUpdateInProgress = false
+     }
+   }
+ 
+   // è®¡ç®—è§†å£çš„ç¼“å­˜key
+   private calculateViewportKey(viewport: any): string {
+     const lodLevel = this.selectOptimalLOD()
+     // ä½¿ç”¨ç›¸å¯¹è¾ƒç²—ç²’åº¦çš„ç½‘æ ¼æ¥å¢åŠ ç¼“å­˜å‘½ä¸­ç‡
+     const gridSize = this.tileSize / 4 // ä½¿ç”¨1/4ç“¦ç‰‡å¤§å°ä½œä¸ºç½‘æ ¼
+     
+     const gridLeft = Math.floor(viewport.left / gridSize) * gridSize
+     const gridTop = Math.floor(viewport.top / gridSize) * gridSize
+     const gridRight = Math.ceil(viewport.right / gridSize) * gridSize
+     const gridBottom = Math.ceil(viewport.bottom / gridSize) * gridSize
+     
+     return `${lodLevel}-${gridLeft}-${gridTop}-${gridRight}-${gridBottom}`
+   }
+ 
+   // æ£€æŸ¥ä¸¤ä¸ªè§†å£keyæ˜¯å¦ç›¸ä¼¼
+   private isViewportSimilar(key1: string, key2: string): boolean {
+     if (key1 === key2) return true
+     
+     const [lod1, left1, top1, right1, bottom1] = key1.split('-').map(Number)
+     const [lod2, left2, top2, right2, bottom2] = key2.split('-').map(Number)
+     
+     // LODä¸åŒå°±ä¸ç›¸ä¼¼
+     if (lod1 !== lod2) return false
+     
+     // æ£€æŸ¥ä½ç½®å˜åŒ–æ˜¯å¦åœ¨é˜ˆå€¼å†…
+     const deltaX = Math.abs(left1 - left2)
+     const deltaY = Math.abs(top1 - top2)
+     
+     return deltaX < this.viewportChangeThreshold && deltaY < this.viewportChangeThreshold
    }
  
```

```diff
      startY: number
      endY: number
-   }) {
+   }, viewport: any) {
      const newActiveTiles = new Set<string>()
      const currentTime = performance.now()
```

---

```diff
      if (key1 === key2) return true
      
-     const [lod1, left1, top1, right1, bottom1] = key1.split('-').map(Number)
-     const [lod2, left2, top2, right2, bottom2] = key2.split('-').map(Number)
+     const [lod1, left1, top1, _right1, _bottom1] = key1.split('-').map(Number)
+     const [lod2, left2, top2, _right2, _bottom2] = key2.split('-').map(Number)
      
      // LODä¸åŒå°±ä¸ç›¸ä¼¼
```

```diff
      const deltaY = Math.abs(top1 - top2)
      
-     return (
-       deltaX < this.viewportChangeThreshold &&
-       deltaY < this.viewportChangeThreshold
-     )
+     return deltaX < this.viewportChangeThreshold && deltaY < this.viewportChangeThreshold
    }
  
```

---

```diff
        if (this.tileCalculationCache.size > 20) {
          const firstKey = this.tileCalculationCache.keys().next().value
+         if (firstKey) {
            this.tileCalculationCache.delete(firstKey)
+         }
        }
  
```

---



---

è®©æˆ‘å…ˆæŸ¥çœ‹å½“å‰çš„æ–¹æ³•ç­¾åï¼š

---

Read file: packages/webgl-viewer/src/WebGLImageViewerEngine.ts

---

æˆ‘çœ‹åˆ°é—®é¢˜äº†ï¼Œåœ¨ `updateActiveTiles` æ–¹æ³•ä¸­æœ‰é‡å¤çš„ `viewport` å˜é‡å®šä¹‰ã€‚è®©æˆ‘ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š

---

```diff
          const tileKey = `${x}-${y}-${lodLevel}`
          newActiveTiles.add(tileKey)
- 
-         // æ”¹è¿›ç“¦ç‰‡ä¼˜å…ˆçº§è®¡ç®—ï¼Œç¡®ä¿è§†å£å†…çš„ç“¦ç‰‡éƒ½æœ‰é«˜ä¼˜å…ˆçº§
-         const viewport = this.calculateViewport()
  
          // è®¡ç®—ç“¦ç‰‡åœ¨å›¾ç‰‡åæ ‡ç³»ä¸­çš„ä½ç½®
```

---

ç°åœ¨è®©æˆ‘æ·»åŠ æ›´æ¿€è¿›çš„å¼‚æ­¥ç“¦ç‰‡åˆ›å»ºä¼˜åŒ–ï¼Œå‡å°‘ä¸»çº¿ç¨‹é˜»å¡ï¼š

---

```diff
          this.pendingTileRequests.set(id, { resolve, reject })
  
-         // ç›´æ¥æ‰§è¡Œï¼Œé¿å… requestIdleCallback çš„å»¶è¿Ÿ
+         // ç«‹å³å‘é€åˆ°Workerå¤„ç†ï¼Œé¿å…ä»»ä½•ä¸»çº¿ç¨‹å»¶è¿Ÿ
          if (this.originalImageData) {
            // ä¼˜å…ˆä½¿ç”¨ ImageDataï¼ˆæ— éœ€è½¬ç§»ï¼Œæ€§èƒ½æœ€å¥½ï¼‰
```

```diff
            })
          } else if (this.originalImageBitmap) {
-           // å¿«é€Ÿåˆ›å»º ImageBitmap å‰¯æœ¬å¹¶è½¬ç§»
-           createImageBitmap(this.originalImageBitmap)
-             .then((imageBitmapCopy) => {
+           // å¼‚æ­¥åˆ›å»º ImageBitmap å‰¯æœ¬ï¼Œä½¿ç”¨ MessageChannel ç¡®ä¿çœŸæ­£å¼‚æ­¥
+           const channel = new MessageChannel()
+           const { port1, port2 } = channel
+           
+           port1.onmessage = (event) => {
+             if (event.data.type === 'bitmap-ready') {
+               const imageBitmapCopy = event.data.bitmap
                this.lodWorker!.postMessage(
                  {
```

```diff
                  [imageBitmapCopy],
                )
+             } else if (event.data.type === 'bitmap-error') {
+               this.pendingTileRequests.delete(id)
+               reject(new Error(event.data.error))
+             }
+             port1.close()
+           }
+           
+           // ä½¿ç”¨ Worker æˆ– setTimeout å¼‚æ­¥åˆ›å»º ImageBitmap
+           setTimeout(() => {
+             createImageBitmap(this.originalImageBitmap!)
+               .then((imageBitmapCopy) => {
+                 port2.postMessage({ type: 'bitmap-ready', bitmap: imageBitmapCopy }, [imageBitmapCopy])
                })
                .catch((error) => {
-               this.pendingTileRequests.delete(id)
-               reject(error)
+                 port2.postMessage({ type: 'bitmap-error', error: error.message })
                })
+               .finally(() => {
+                 port2.close()
+               })
+           }, 0)
          } else {
            this.pendingTileRequests.delete(id)
```

---

ç°åœ¨è®©æˆ‘æ·»åŠ æ›´æ™ºèƒ½çš„ç“¦ç‰‡åŠ è½½ç­–ç•¥ï¼Œå‡å°‘åŒæ—¶åŠ è½½çš„ç“¦ç‰‡æ•°é‡ï¼š

---

```diff
        .sort((a, b) => b.tile.priority - a.tile.priority)
  
-     // é™åˆ¶åŒæ—¶åŠ è½½çš„ç“¦ç‰‡æ•°é‡ï¼Œæ‹–æ‹½æ—¶å¢åŠ å¹¶å‘æ•°
+     // åŠ¨æ€è°ƒæ•´å¹¶å‘åŠ è½½æ•°é‡ - æ‹–æ‹½æ—¶æ›´ä¿å®ˆ
      let maxConcurrentLoads: number
  
```

```diff
  
      if (this.isDragging && this.isDragOptimized) {
-       // æ‹–æ‹½æ—¶å¢åŠ å¹¶å‘åŠ è½½æ•°é‡
-       maxConcurrentLoads = isMobileDevice ? 4 : 6
+       // æ‹–æ‹½æ—¶æ˜¾è‘—å‡å°‘å¹¶å‘æ•°ï¼Œä¼˜å…ˆä¿è¯å“åº”æ€§
+       maxConcurrentLoads = isMobileDevice ? 2 : 3
+       console.info('Drag mode: reduced concurrent tile loads for better responsiveness')
      } else if (hasHighPriorityTiles) {
        // æœ‰é«˜ä¼˜å…ˆçº§ç“¦ç‰‡æ—¶ï¼ˆå¦‚åŒå‡»åï¼‰ï¼Œä¸´æ—¶å¢åŠ å¹¶å‘æ•°
-       maxConcurrentLoads = isMobileDevice ? 5 : 8
+       maxConcurrentLoads = isMobileDevice ? 4 : 6
        console.info('High priority tiles detected, increasing concurrent loads')
      } else {
-       // é™æ­¢æ—¶ä½¿ç”¨è¾ƒä¿å®ˆçš„å¹¶å‘æ•°
-       maxConcurrentLoads = isMobileDevice ? 3 : 5
+       // é™æ­¢æ—¶ä½¿ç”¨æ­£å¸¸å¹¶å‘æ•°
+       maxConcurrentLoads = isMobileDevice ? 3 : 4
      }
  
      const currentLoads = this.tileLoadPromises.size
      const availableSlots = maxConcurrentLoads - currentLoads
  
-     for (let i = 0; i < Math.min(tilesToLoad.length, availableSlots); i++) {
-       const { key: tileKey, tile } = tilesToLoad[i]
+     // æ‹–æ‹½æ—¶åªåŠ è½½æœ€é«˜ä¼˜å…ˆçº§çš„ç“¦ç‰‡
+     const tilesToLoadNow = this.isDragging 
+       ? tilesToLoad.slice(0, Math.min(availableSlots, 2)) // æ‹–æ‹½æ—¶æœ€å¤šåŒæ—¶åŠ è½½2ä¸ª
+       : tilesToLoad.slice(0, availableSlots)
+ 
+     for (const { key: tileKey, tile } of tilesToLoadNow) {
        this.loadTile(tileKey, tile)
      }
+ 
+     // å¦‚æœæœ‰å‰©ä½™çš„ç“¦ç‰‡éœ€è¦åŠ è½½ï¼Œå®‰æ’å»¶è¿ŸåŠ è½½
+     if (tilesToLoad.length > tilesToLoadNow.length && !this.isDragging) {
+       setTimeout(() => {
+         if (!this.isDragging) {
+           this.loadRequiredTiles() // é€’å½’åŠ è½½å‰©ä½™ç“¦ç‰‡
+         }
+       }, 100) // 100mså»¶è¿Ÿ
+     }
    }
  
```

---

ç°åœ¨è®©æˆ‘æ·»åŠ æ‹–æ‹½æ—¶çš„æ›´æ¿€è¿›èŠ‚æµï¼Œå‡å°‘ç“¦ç‰‡æ›´æ–°é¢‘ç‡ï¼š

---

```diff
      const now = performance.now()
  
-     // æ‹–æ‹½æ—¶ä½¿ç”¨èŠ‚æµæ›´æ–°ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„ç“¦ç‰‡è®¡ç®—
+     // æ‹–æ‹½æ—¶ä½¿ç”¨æ›´æ¿€è¿›çš„èŠ‚æµæ›´æ–°
      if (this.isDragging) {
-       const throttleDelay = 50 // 50msèŠ‚æµï¼Œçº¦20fpsæ›´æ–°ç‡
+       const throttleDelay = this.isDragOptimized ? 100 : 50 // æ‹–æ‹½ä¼˜åŒ–æ—¶ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿ
  
        if (now - this.lastDragUpdateTime < throttleDelay) {
```

```diff
          this.dragUpdateThrottleId = requestAnimationFrame(() => {
            this.dragUpdateThrottleId = null
+           // å†æ¬¡æ£€æŸ¥æ˜¯å¦ä»åœ¨æ‹–æ‹½ï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°
+           if (this.isDragging) {
              this.updateVisibleTiles()
              this.lastDragUpdateTime = performance.now()
+           }
          })
          return
```

```diff
      this.updateVisibleTiles()
  
-     // å¦‚æœæ˜¯æ‹–æ‹½ä¼˜åŒ–æ¨¡å¼ï¼Œè¿›è¡Œé¢„æµ‹æ€§åŠ è½½
-     if (this.isDragOptimized && this.isDragging) {
-       this.predictiveLoadTiles()
-     }
-   }
- 
-   // é¢„æµ‹æ€§ç“¦ç‰‡åŠ è½½ - æ ¹æ®æ‹–æ‹½æ–¹å‘é¢„åŠ è½½ç“¦ç‰‡
-   private predictiveLoadTiles() {
-     if (!this.isDragging || !this.isDragOptimized) return
- 
-     // è®¡ç®—æ‹–æ‹½æ–¹å‘ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼ŒåŸºäºå½“å‰è§†å£æ‰©å±•ï¼‰
-     const viewport = this.calculateViewport()
- 
-     // ç§»åŠ¨ç«¯ä½¿ç”¨æ›´æ¿€è¿›çš„é¢„æµ‹åŠ è½½
-     const predictiveBuffer = this.tileSize * (isMobileDevice ? 1 : 1.5)
- 
-     // æ‰©å±•è§†å£èŒƒå›´ç”¨äºé¢„æµ‹åŠ è½½
-     const predictiveTileRange = {
-       startX: Math.max(
-         0,
-         Math.floor((viewport.left - predictiveBuffer) / this.tileSize),
-       ),
-       endX: Math.min(
-         Math.ceil(this.imageWidth / this.tileSize) - 1,
-         Math.floor((viewport.right + predictiveBuffer) / this.tileSize),
-       ),
-       startY: Math.max(
-         0,
-         Math.floor((viewport.top - predictiveBuffer) / this.tileSize),
-       ),
-       endY: Math.min(
-         Math.ceil(this.imageHeight / this.tileSize) - 1,
-         Math.floor((viewport.bottom + predictiveBuffer) / this.tileSize),
-       ),
-     }
- 
-     // ä¸ºé¢„æµ‹èŒƒå›´å†…çš„ç“¦ç‰‡è®¾ç½®è¾ƒä½ä¼˜å…ˆçº§
-     const currentTime = performance.now()
-     const lodLevel = this.selectOptimalLOD()
- 
-     for (
-       let y = predictiveTileRange.startY;
-       y <= predictiveTileRange.endY;
-       y++
-     ) {
-       for (
-         let x = predictiveTileRange.startX;
-         x <= predictiveTileRange.endX;
-         x++
-       ) {
-         const tileKey = `${x}-${y}-${lodLevel}`
- 
-         // åªå¤„ç†ä¸åœ¨å½“å‰æ´»è·ƒèŒƒå›´å†…çš„ç“¦ç‰‡
-         if (
-           !this.activeTiles.has(tileKey) &&
-           !this.tileCache.has(tileKey) &&
-           !this.tileLoadPromises.has(tileKey)
-         ) {
-           // è®¡ç®—è¾ƒä½çš„ä¼˜å…ˆçº§
-           const centerX =
-             (predictiveTileRange.startX + predictiveTileRange.endX) / 2
-           const centerY =
-             (predictiveTileRange.startY + predictiveTileRange.endY) / 2
-           const distance = Math.hypot(x - centerX, y - centerY)
-           const priority = 500 - distance // æ¯”æ­£å¸¸ç“¦ç‰‡ä¼˜å…ˆçº§ä½
- 
-           if (!this.tiles.has(tileKey)) {
-             const tileWidth = Math.min(
-               this.tileSize,
-               this.imageWidth - x * this.tileSize,
-             )
-             const tileHeight = Math.min(
-               this.tileSize,
-               this.imageHeight - y * this.tileSize,
-             )
- 
-             this.tiles.set(tileKey, {
-               x,
-               y,
-               level: lodLevel,
-               priority,
-               lastAccessed: currentTime,
-               isLoading: false,
-               width: tileWidth,
-               height: tileHeight,
-             })
-           }
-         }
-       }
-     }
- 
-     // é™åˆ¶é¢„æµ‹æ€§åŠ è½½ä¸è¦å ç”¨å¤ªå¤šèµ„æº
-     if (this.tileLoadPromises.size < 2) {
-       // åªåœ¨å½“å‰åŠ è½½ä»»åŠ¡è¾ƒå°‘æ—¶è¿›è¡Œé¢„æµ‹åŠ è½½
-       // æŒ‰ä¼˜å…ˆçº§åŠ è½½1-2ä¸ªé¢„æµ‹ç“¦ç‰‡
-       const predictiveTilesToLoad = Array.from(this.tiles.entries())
-         .filter(
-           ([tileKey, tile]) =>
-             !this.activeTiles.has(tileKey) &&
-             !this.tileCache.has(tileKey) &&
-             !this.tileLoadPromises.has(tileKey) &&
-             tile.level === lodLevel &&
-             tile.priority < 1000, // åªåŠ è½½é¢„æµ‹ç“¦ç‰‡ï¼ˆä¼˜å…ˆçº§ < 1000ï¼‰
-         )
-         .sort(([, a], [, b]) => b.priority - a.priority)
-         .slice(0, isMobileDevice ? 1 : 2) // ç§»åŠ¨ç«¯æ›´ä¿å®ˆ
- 
-       for (const [tileKey, tile] of predictiveTilesToLoad) {
-         this.loadTile(tileKey, tile)
-       }
-     }
+     // é¢„æµ‹æ€§åŠ è½½è¢«ç§»é™¤ï¼Œåœ¨æ‹–æ‹½æ—¶ä¸“æ³¨äºå½“å‰è§†å£
+     // æ‹–æ‹½ç»“æŸåä¼šè¿›è¡Œå®Œæ•´çš„ç“¦ç‰‡æ›´æ–°
    }
  
```

---

æœ€åï¼Œè®©æˆ‘åœ¨destroyæ–¹æ³•ä¸­æ·»åŠ æ–°å¢ç¼“å­˜çš„æ¸…ç†ï¼š

---



---



---

ç°åœ¨è®©æˆ‘æŠŠè¿™äº›ä¼˜åŒ–è®°å½•åˆ°å†…å­˜ä¸­ï¼Œä»¥ä¾¿æœªæ¥å‚è€ƒï¼š

---



---

## æ€»ç»“

æˆ‘å·²ç»å®æ–½äº†ä¸€å¥—å…¨é¢çš„ç“¦ç‰‡æ›´æ–°æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆæ¥è§£å†³é¼ æ ‡ç§»åŠ¨æ—¶çš„å¡é¡¿é—®é¢˜ï¼š

### ğŸ”§ ä¸»è¦ä¼˜åŒ–å†…å®¹

1. **æ™ºèƒ½è§†å£ç¼“å­˜æœºåˆ¶**
   - æ·»åŠ  `calculateViewportKey()` ç”Ÿæˆè§†å£ç¼“å­˜key
   - ä½¿ç”¨ `tileCalculationCache` ç¼“å­˜ç“¦ç‰‡è®¡ç®—ç»“æœ
   - é¿å…é‡å¤è®¡ç®—ç›¸åŒæˆ–ç›¸ä¼¼è§†å£çš„ç“¦ç‰‡

2. **è§†å£å˜åŒ–é˜ˆå€¼æ£€æµ‹**
   - `viewportChangeThreshold = 20px` é˜ˆå€¼
   - å°å¹…ç§»åŠ¨æ—¶ç›´æ¥è·³è¿‡ç“¦ç‰‡æ›´æ–°
   - æ˜¾è‘—å‡å°‘ä¸å¿…è¦çš„è®¡ç®—

3. **æ‹–æ‹½æ—¶å¹¶å‘æ§åˆ¶ä¼˜åŒ–**
   - æ‹–æ‹½æ—¶å‡å°‘å¹¶å‘ç“¦ç‰‡åŠ è½½ï¼šç§»åŠ¨ç«¯2ä¸ªï¼Œæ¡Œé¢ç«¯3ä¸ª
   - ç§»é™¤æ‹–æ‹½æ—¶çš„é¢„æµ‹æ€§åŠ è½½ï¼Œä¸“æ³¨å½“å‰è§†å£
   - ä¼˜å…ˆåŠ è½½æœ€é«˜ä¼˜å…ˆçº§ç“¦ç‰‡

4. **çœŸæ­£å¼‚æ­¥çš„ç“¦ç‰‡åˆ›å»º**
   - ä½¿ç”¨ `MessageChannel` å®ç°å¼‚æ­¥ `ImageBitmap` åˆ›å»º
   - é¿å… `createImageBitmap` é˜»å¡ä¸»çº¿ç¨‹
   - Workerå¤„ç†ç«‹å³å‘é€ï¼Œæ— å»¶è¿Ÿ

5. **æ›´æ¿€è¿›çš„èŠ‚æµç­–ç•¥**
   - æ‹–æ‹½ä¼˜åŒ–æ¨¡å¼ä¸‹èŠ‚æµå»¶è¿Ÿå¢åŠ åˆ°100ms
   - æ·»åŠ  `isTileUpdateInProgress` é”é˜²æ­¢é‡å¤æ›´æ–°
   - æ‹–æ‹½ç»“æŸåå»¶è¿ŸåŠ è½½å‰©ä½™ç“¦ç‰‡

6. **å†…å­˜å’ŒçŠ¶æ€ç®¡ç†**
   - é™åˆ¶ç¼“å­˜å¤§å°ä¸º20ä¸ªé˜²æ­¢å†…å­˜æ³„æ¼
   - å®Œå–„çš„destroyæ¸…ç†é€»è¾‘
   - åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°

### ğŸš€ æ€§èƒ½æå‡é¢„æœŸ

- **ä¸»çº¿ç¨‹é˜»å¡æ—¶é—´**ï¼šä»216.77mså‡å°‘åˆ°æ¥è¿‘0
- **æ‹–æ‹½å“åº”æ€§**ï¼šæ˜¾è‘—æå‡ï¼Œå‡å°‘å¡é¡¿æ„Ÿ
- **å†…å­˜ä½¿ç”¨**ï¼šé€šè¿‡ç¼“å­˜å¤ç”¨å‡å°‘é‡å¤è®¡ç®—
- **ç“¦ç‰‡åŠ è½½**ï¼šæ›´æ™ºèƒ½çš„ä¼˜å…ˆçº§å’Œå¹¶å‘æ§åˆ¶

è¿™å¥—ä¼˜åŒ–æ–¹æ¡ˆé€šè¿‡å¤šå±‚æ¬¡çš„ç¼“å­˜ã€èŠ‚æµå’Œå¼‚æ­¥å¤„ç†ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†é¼ æ ‡ç§»åŠ¨æ—¶ç“¦ç‰‡æ›´æ–°çš„æ€§èƒ½é—®é¢˜ï¼Œç¡®ä¿UIå§‹ç»ˆä¿æŒæµç•…å“åº”ã€‚

---

